<!DOCTYPE html>
<html lang="ja">


<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <script type="text/javascript" src="../lib/jquery.min.js"></script>
    <script type="text/javascript" src="../lib/osql.js"></script>

    <script>
        osql.requireLogin();
    </script>

</head>

<body>
    <h1>オペレーター登録情報修正ページ</h1>
    名前:<input id="name" value="" type="textfield">
    <br>

    年齢:<input id="age" type="number" value="15">
    <br>

    隊長:<input id="is_captain" value="" type="checkbox">
    <br>

    所属部隊:
    <select id="party">
        <option value="null">所属なし</option>
    </select>
    <br>

    画像URL:<input id="image" value="" type="textfield">
    <br>
    <img id="imageUrlChecker" src="../images/no_image.png" width="auto" height="100">
    <br>

    ステータス
    <div id="status_form">
        トリオン:<input id="trion"　type="number" value="0">
        機器操作:<input id="equipment_operation" type="number" value="0">
        <br>
        情報分析:<input id="analysis" type="number" value="0">
        並列処理:<input id="parallel_thinking" type="number" value="0">
        <br>
        戦術:<input id="tactics" type="number" value="0">
        指揮:<input id="order" type="number" value="0">
    </div>

    <br>
    <button onclick="button1Pressed()">修正</button>
    <br>
    <p id="result"></p>

    <script>
        $(document).ready(function () {
            setRegisteredData();
        });

        async function makePartyForm() {
            const sql = 'select party_id, party_name from party';
            const objects = await osql.connect(sql);
            for(var i=0;i<objects.length;i++){
                let option = document.createElement("option");
                option.value = objects[i].party_name;
                option.text = objects[i].party_name + '隊';
                document.getElementById("party").appendChild(option);
            }
            
        }

        async function setRegisteredData() {
            await makePartyForm();
            const name = osql.getParam('member_name');
            var sql = `select * from member where member_name="${name}";`
            var objects = await osql.connect(sql);
            document.getElementById('name').value = objects[0].member_name;
            document.getElementById('age').value = objects[0].age;
            if(objects[0].is_captain == 1) {
                document.getElementById('is_captain').checked = true;
            }
            document.getElementById('party').value = objects[0].party_name;
            document.getElementById('image').value = objects[0].image_url;
            document.getElementById("imageUrlChecker").src = objects[0].image_url;

            var sql = `select * from operator where member_name="${name}";`
            var objects = await osql.connect(sql);
            document.getElementById('trion').value = objects[0].trion_status;
            document.getElementById('equipment_operation').value = objects[0].equipment_operation_status;
            document.getElementById('analysis').value = objects[0].analysis_status;
            document.getElementById('parallel_thinking').value = objects[0].parallel_thinking_status;
            document.getElementById('tactics').value = objects[0].tactics_status;
            document.getElementById('order').value = objects[0].order_status;
        }

        async function updateMember() {
            const name = '"' + document.getElementById('name').value + '"';
            const age = document.getElementById('age').value;
            const is_captain = document.getElementById('is_captain').checked
            let party = document.getElementById('party').value;
            if (party=='null') {
                party = 'NULL';
            } else {
                party = '"' + party + '"';
            }
            let image_url = document.getElementById('image').value;
            if (image_url) { 
                image_url = '"' + image_url + '"';
            } else {
                image_url = 'NULL';
            }

            const sql_for_member = 
                `update member set
                member_name = ${name},
                party_name = ${party},
                age = ${age},
                is_captain = ${is_captain},
                position = "オペレーター",
                image_url = ${image_url}
                where
                member_name = ${name};`;
            var objects = await osql.connect(sql_for_member);
        }

        async function updateOperator() {
            const name = '"' + document.getElementById('name').value + '"';
            const trion = document.getElementById('trion').value;
            const equipment_operation = document.getElementById('equipment_operation').value;
            const analysis = document.getElementById('analysis').value;
            const parallel_thinking = document.getElementById('parallel_thinking').value;
            const tactics = document.getElementById('tactics').value;
            const order = document.getElementById('order').value;

            const sql_for_operator =  
            `update operator set 
            member_name = ${name}, 
            trion_status = ${trion},
            equipment_operation_status = ${equipment_operation},
            analysis_status = ${analysis},
            parallel_thinking_status = ${parallel_thinking},
            tactics_status = ${tactics},
            order_status = ${order}
            where
            member_name = ${name};`

            var objects = await osql.connect(sql_for_operator);
        }

        async function button1Pressed() {
            await updateMember();
            await updateOperator();
            location.href = 'operator_detail.html?member_name=' + osql.getParam('member_name');
        }

        var member_image_url_form = document.getElementById('image');
        member_image_url_form.addEventListener('input', function(){
            var image_url_checker = document.getElementById("imageUrlChecker");
            image_url_checker.src = this.value;
        })
    </script>
</body>

</html>